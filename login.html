<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartStock - Secure Login</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'primary-green': '#10B981',
        'dark-bg': '#0F172A',
        'card-bg': '#1E293B',
      },
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
      },
    }
  }
}
</script>
<style>
body {
  font-family: 'Inter', sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background-color: #0F172A;
}

/* Ghost styling */
.ghost {
  width: 100px;
  height: 100px;
  background: #10B981;
  border-radius: 50% 50% 0 0;
  position: relative;
  margin: 20px auto 40px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(16,185,129,0.4);
}
.ghost::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 20px;
  background: #10B981;
  clip-path: polygon(0% 0%, 15% 100%, 30% 0%, 50% 100%, 70% 0%, 85% 100%, 100% 0%);
}
.eye {
  width: 30px;
  height: 30px;
  background: white;
  border-radius: 50%;
  position: absolute;
}
.pupil {
  width: 10px;
  height: 10px;
  background: #0F172A;
  border-radius: 50%;
  position: absolute;
  transition: transform 0.2s;
}
</style>
</head>
<body>
  <div class="w-full max-w-sm">
    <div class="bg-card-bg p-8 rounded-xl shadow-2xl border-t-4 border-primary-green">
      <!-- Ghost -->
      <div class="ghost" id="ghost">
        <div class="eye" id="eyeLeft" style="left:20px;top:20px;">
          <div class="pupil" id="pupilLeft" style="left:10px;top:10px;"></div>
        </div>
        <div class="eye" id="eyeRight" style="left:50px;top:20px;">
          <div class="pupil" id="pupilRight" style="left:10px;top:10px;"></div>
        </div>
      </div>

      <h1 class="text-3xl font-extrabold text-white mb-2 text-center">SmartStock Access</h1>
      <p id="formTitle" class="text-xl font-semibold text-primary-green mb-6 text-center">Login</p>

      <!-- Message -->
      <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm font-medium" role="alert"></div>
      <!-- Login Form -->
      <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
        <input id="username" type="text" placeholder="Username" required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-green focus:border-primary-green" />
        <input id="password" type="password" placeholder="Password" required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-green focus:border-primary-green" />
        <button type="submit" 
          class="w-full py-2 px-4 rounded-md font-medium text-white bg-primary-green hover:bg-emerald-600 transition">
          Login
        </button>
      </form>

      <!-- Register Form -->
      <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4 hidden">
        <input id="regEmail" type="email" placeholder="Email" required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-green focus:border-primary-green" />
        <input id="regUsername" type="text" placeholder="Username" required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-green focus:border-primary-green" />
        <input id="regPassword" type="password" placeholder="Password" required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-green focus:border-primary-green" />
        <button type="submit" 
          class="w-full py-2 px-4 rounded-md font-medium text-white bg-primary-green hover:bg-emerald-600 transition">
          Register
        </button>
      </form>

      <!-- Toggle -->
      <div class="mt-4 text-center">
        <div class="toggle text-sm cursor-pointer text-gray-400 hover:text-primary-green" id="toggleToRegister">
          Donâ€™t have an account? <span class="font-semibold text-primary-green underline">Register</span>
        </div>
        <div class="toggle text-sm cursor-pointer text-gray-400 hover:text-primary-green hidden" id="toggleToLogin">
          Already registered? <span class="font-semibold text-primary-green underline">Login</span>
        </div>
      </div>
    </div>
  </div>
<script>
// === Part 1: Config + Auth Helpers ===
const API_BASE = "https://smartstock-qre1.onrender.com"; // your Render backend
// UI elements you may have in your pages:
const alertBox = document.getElementById("alertBox"); // optional message area

// Utility: show human-readable messages (no [object Object])
function parseErrorMessage(data) {
  if (!data) return "Unknown error";
  if (typeof data === "string") return data;
  if (data.detail) {
    if (typeof data.detail === "string") return data.detail;
    if (Array.isArray(data.detail)) return data.detail.map(d => (d.msg || JSON.stringify(d))).join(", ");
    return JSON.stringify(data.detail);
  }
  if (data.message) return data.message;
  return JSON.stringify(data);
}
function showAlert(msg, type = "info") {
  // type: info | success | error
  if (alertBox) {
    alertBox.textContent = msg;
    alertBox.className = "alert " + type;
    // auto-hide after 4s
    clearTimeout(showAlert._t); showAlert._t = setTimeout(()=> { alertBox.textContent = ""; alertBox.className = ""; }, 4000);
  } else {
    // fallback
    if (type === "error") console.error(msg); else console.log(msg);
  }
}

// Token helpers
function setTokens({ access_token, refresh_token, user_id, username }) {
  if (access_token) localStorage.setItem("access_token", access_token);
  if (refresh_token) localStorage.setItem("refresh_token", refresh_token);
  if (user_id !== undefined && user_id !== null) localStorage.setItem("user_id", String(user_id));
  if (username) localStorage.setItem("username", username);
}
function getAccessToken() { return localStorage.getItem("access_token"); }
function getRefreshToken() { return localStorage.getItem("refresh_token"); }
function getUserId() { return localStorage.getItem("user_id"); }
function clearAuth() {
  localStorage.removeItem("access_token");
  localStorage.removeItem("refresh_token");
  localStorage.removeItem("user_id");
  localStorage.removeItem("username");
}

// Refresh flow: call /refresh with { refresh_token }
async function refreshAccessToken() {
  const rt = getRefreshToken();
  if (!rt) return null;
  try {
    const res = await fetch(`${API_BASE}/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: rt })
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) {
      // expired / invalid refresh -> logout
      clearAuth();
      return null;
    }
    if (data && data.access_token) {
      setTokens({ access_token: data.access_token });
      return data.access_token;
    }
    return null;
  } catch (err) {
    console.error("refreshAccessToken error", err);
    return null;
  }
}

// fetch wrapper: attaches Authorization, auto-refreshes once on 401/403
async function fetchWithAuth(path, opts = {}) {
  opts.headers = opts.headers ? { ...opts.headers } : {};
  let token = getAccessToken();
  if (token) opts.headers["Authorization"] = "Bearer " + token;
  if (!opts.headers["Content-Type"] && !(opts.body instanceof FormData)) opts.headers["Content-Type"] = "application/json";

  let res;
  try {
    res = await fetch(`${API_BASE}${path}`, opts);
  } catch (err) {
    // network-level error
    throw new Error("Network error: " + (err.message || err));
  }

  if (res.status === 401 || res.status === 403) {
    // try refresh once
    const newToken = await refreshAccessToken();
    if (newToken) {
      opts.headers["Authorization"] = "Bearer " + newToken;
      try {
        res = await fetch(`${API_BASE}${path}`, opts);
      } catch (err) {
        throw new Error("Network error on retry: " + (err.message || err));
      }
    } else {
      // cannot refresh -> force logout
      clearAuth();
      throw new Error("Session expired. Please log in again.");
    }
  }
  return res;
}
// === Part 2: Login & Register ===

// Register: POST /register { username, email, password }
async function doRegister({ username, email, password }) {
  if (!username || !email || !password) throw new Error("All register fields required");
  try {
    const res = await fetch(`${API_BASE}/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, email, password })
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    return data; // success message + user_id
  } catch (err) {
    throw err;
  }
}

// Login: POST /login { username, password } -> stores tokens and user_id
async function doLogin({ username, password }) {
  if (!username || !password) throw new Error("Username and password required");
  try {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    // backend returns access_token, refresh_token, user_id, username
    setTokens({
      access_token: data.access_token,
      refresh_token: data.refresh_token,
      user_id: data.user_id,
      username: data.username
    });
    return data;
  } catch (err) {
    throw err;
  }
}

// helper: ensure user is authenticated (try refresh if access missing)
async function ensureAuthOrRedirect() {
  const uid = getUserId();
  if (!uid) {
    clearAuth();
    window.location.href = "index.html"; // login page
    return false;
  }
  let at = getAccessToken();
  if (!at && getRefreshToken()) {
    const newToken = await refreshAccessToken();
    if (!newToken) { clearAuth(); window.location.href = "index.html"; return false; }
  }
  return true;
}
// === Part 3: Inventory CRUD, rendering, init ===

// Normalize backend item -> frontend shape
function normalizeItem(i) {
  return {
    id: i.id,
    item_name: i.item_name || i.pname || i.name,
    dsc: i.dsc || "",
    category: i.category || "Uncategorized",
    qty: Number(i.qty || 0),
    unit: i.unit || "",
    exp_date: i.exp_date || i.expiry || null,
    price: Number(i.price || 0),
    date_added: i.date_added || i.created_at || null
  };
}

// Fetch list for current token user: GET /inventory
async function fetchInventory() {
  try {
    const res = await fetchWithAuth(`/inventory`, { method: "GET" });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    const items = (data.items || []).map(normalizeItem);
    // store locally or render directly:
    window._inventory = items;
    renderInventory(items);
    return items;
  } catch (err) {
    console.error("fetchInventory error", err);
    showAlert(err.message || String(err), "error");
    renderInventory([]); // show empty state
    return [];
  }
}

// Add item: POST /add_item/{user_id} (expects InventoryItemIn fields)
async function addItem(item) {
  const user_id = getUserId();
  if (!user_id) throw new Error("User not authenticated");
  // map frontend -> backend field names
  const body = {
    item_name: item.item_name,
    dsc: item.dsc || null,
    category: item.category || null,
    qty: Number(item.qty || 0),
    unit: item.unit || null,
    exp_date: item.exp_date || null,
    price: Number(item.price || 0)
  };
  try {
    const res = await fetchWithAuth(`/add_item/${encodeURIComponent(user_id)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    await fetchInventory();
    showAlert("Item added", "success");
    return data;
  } catch (err) {
    showAlert(err.message || String(err), "error");
    throw err;
  }
}

// Update item: PUT /update_item/{user_id}/{item_id}
async function updateItem(item_id, updates) {
  const user_id = getUserId();
  if (!user_id) throw new Error("User not authenticated");
  const body = {
    item_name: updates.item_name,
    dsc: updates.dsc || null,
    category: updates.category || null,
    qty: Number(updates.qty || 0),
    unit: updates.unit || null,
    exp_date: updates.exp_date || null,
    price: Number(updates.price || 0)
  };
  try {
    const res = await fetchWithAuth(`/update_item/${encodeURIComponent(user_id)}/${encodeURIComponent(item_id)}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    await fetchInventory();
    showAlert("Item updated", "success");
    return data;
  } catch (err) {
    showAlert(err.message || String(err), "error");
    throw err;
  }
}

// Delete item: DELETE /delete_item/{user_id}/{item_id}
async function deleteItem(item_id) {
  const user_id = getUserId();
  if (!user_id) throw new Error("User not authenticated");
  try {
    const res = await fetchWithAuth(`/delete_item/${encodeURIComponent(user_id)}/${encodeURIComponent(item_id)}`, {
      method: "DELETE"
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error(parseErrorMessage(data));
    await fetchInventory();
    showAlert("Item deleted", "success");
    return data;
  } catch (err) {
    showAlert(err.message || String(err), "error");
    throw err;
  }
}

// Simple render function (adjust to your DOM structure)
function renderInventory(items) {
  const tbody = document.querySelector("#inventoryBody");
  if (!tbody) {
    // no table in DOM â€” just keep in window._inventory
    return;
  }
  tbody.innerHTML = "";
  if (!items || items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">No items</td></tr>`;
    return;
  }
  items.forEach(it => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(it.item_name)}</td>
      <td>${escapeHtml(it.category)}</td>
      <td>${escapeHtml(String(it.qty))}</td>
      <td>â‚¹ ${Number(it.price).toFixed(2)}</td>
      <td>${it.exp_date ? new Date(it.exp_date).toLocaleDateString() : "-"}</td>
      <td>
        <button class="btn-edit" data-id="${it.id}">Edit</button>
        <button class="btn-delete" data-id="${it.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // attach handlers
  tbody.querySelectorAll(".btn-edit").forEach(b => {
    b.addEventListener("click", async (ev) => {
      const id = ev.currentTarget.dataset.id;
      const item = window._inventory.find(x => String(x.id) === String(id));
      if (!item) return showAlert("Item not found", "error");
      // prompt-based quick edit (replace with modal if you have one)
      const newName = prompt("Name", item.item_name);
      if (newName === null) return;
      const newQty = prompt("Quantity", item.qty);
      if (newQty === null) return;
      const newPrice = prompt("Price", item.price);
      if (newPrice === null) return;
      await updateItem(id, { item_name: newName, qty: Number(newQty), price: Number(newPrice), category: item.category, dsc: item.dsc, unit: item.unit, exp_date: item.exp_date });
    });
  });
  tbody.querySelectorAll(".btn-delete").forEach(b => {
    b.addEventListener("click", async (ev) => {
      const id = ev.currentTarget.dataset.id;
      if (!confirm("Delete item?")) return;
      await deleteItem(id);
    });
  });
}

// escape helper for rendering
function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

// Initialize: check auth and load inventory
window.addEventListener("DOMContentLoaded", async () => {
  const ok = await ensureAuthOrRedirect();
  if (!ok) return;
  // set UI username if present
  const username = localStorage.getItem("username");
  if (username) {
    const el = document.querySelector("#greeting");
    if (el) el.textContent = `Hello, ${username}`;
  }
  // wire add item form if present
  const addForm = document.querySelector("#addItemForm");
  if (addForm) {
    addForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const item = {
        item_name: form.querySelector("[name='item_name']").value.trim(),
        dsc: form.querySelector("[name='dsc']")?.value || null,
        category: form.querySelector("[name='category']")?.value || "Uncategorized",
        qty: Number(form.querySelector("[name='qty']").value || 0),
        unit: form.querySelector("[name='unit']")?.value || null,
        exp_date: form.querySelector("[name='exp_date']")?.value || null,
        price: Number(form.querySelector("[name='price']").value || 0)
      };
      try {
        await addItem(item);
        form.reset();
      } catch (err) {
        // error shown by addItem
      }
    });
  }
  // logout button
  document.querySelector("#logoutBtn")?.addEventListener("click", () => { clearAuth(); window.location.href = "index.html"; });

  // initial fetch
  await fetchInventory();
});

</body>
</html>



