<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock - Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Use Inter font for consistency -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        // Tailwind Configuration matching the login page theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10B981', /* Emerald Green */
                        'primary-dark': '#0F172A', /* Slate 900 */
                        'card-bg': '#FFFFFF',
                        'accent-light': '#D1FAE5', /* Emerald 100 */
                        'danger': '#EF4444', /* Red 500 */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Style adjustments for better visibility and component consistency */
        input[type="text"], input[type="number"], input[type="date"], select {
            border-color: #E5E7EB; /* Gray 200 */
            transition: all 0.15s ease-in-out;
        }
        input:focus, select:focus {
            border-color: #10B981; /* primary-green */
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .scroll-table {
            max-height: 55vh; /* Limit height for responsiveness */
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingOverlay" class="fixed inset-0 bg-primary-dark bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-white text-xl flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-primary-green" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting to SmartStock...
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Top Bar -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pb-6 border-b border-gray-200 mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary-green text-white font-extrabold shadow-lg">SI</div>
                <div>
                    <h1 class="text-2xl font-bold text-primary-dark">SmartStock Inventory</h1>
                    <p class="text-sm text-gray-500">Real-time inventory powered by Firebase</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div id="greeting" class="px-3 py-1.5 text-sm font-semibold text-primary-dark bg-accent-light rounded-lg shadow-sm">Hello, User ðŸ‘‹</div>
                <button id="logoutBtn" class="px-4 py-2 text-sm font-medium text-white bg-danger rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Grid Layout (Responsive) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Content Area (Inventory List & Form) -->
            <div class="lg:col-span-2">
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    
                    <!-- NEW: Inventory Title & Filter Control -->
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-primary-dark">Inventory Management</h2>
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-600">Filter by Category:</label>
                            <select id="categoryFilter" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 focus:ring-primary-green">
                                <option value="All">All Categories</option>
                                <option>Groceries</option>
                                <option>Medicines</option>
                                <option>Packaged Food</option>
                                <option>Dairy & Milk Products</option>
                            </select>
                        </div>
                    </div>
                    <!-- END NEW HEADER -->

                    <!-- Item Addition Form -->
                    <div id="addForm" class="flex flex-wrap gap-3 mb-6 p-4 bg-gray-50 rounded-lg border">
                        <input id="nameInput" type="text" placeholder="Item name" required class="flex-grow min-w-[120px] px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <input id="qtyInput" type="number" placeholder="Qty" min="0" required class="w-20 px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <input id="priceInput" type="number" step="0.01" placeholder="Price (â‚¹)" min="0" class="w-28 px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <!-- START: Requested Label and Input -->
                        <div class="flex items-center border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <label for="expiryInput" class="text-sm text-gray-500 font-medium pl-3 pr-2">Expiry Date</label>
                            <input id="expiryInput" type="date" class="w-36 px-3 py-2 border-l border-none focus:ring-primary-green focus:border-primary-green rounded-r-lg" style="border:none;" />
                        </div>
                        <!-- END: Requested Label and Input -->
                        <select id="categoryInput" class="px-3 py-2 rounded-lg border focus:ring-primary-green">
                            <option>Groceries</option>
                            <option>Medicines</option>
                            <option>Packaged Food</option>
                            <option>Dairy & Milk Products</option>
                        </select>
                        <button id="addBtn" class="flex-shrink-0 px-4 py-2 font-medium text-white bg-primary-green rounded-lg shadow-md hover:bg-emerald-600 transition duration-150">
                            âž• Add Item
                        </button>
                    </div>

                    <!-- Filter, Sort, and Alerts (Now just Sort and Alerts) -->
                    <div class="flex flex-wrap justify-end items-center gap-6 mb-4 border-b pb-3">
                        
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-600">Sort By:</label>
                            <select id="sortSelect" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 focus:ring-primary-green">
                                <option value="new">Newest</option>
                                <option value="name">Name</option>
                                <option value="qty_desc">Quantity â†“</option>
                                <option value="qty_asc">Quantity â†‘</option>
                            </select>
                        </div>

                        <!-- Low Stock Alert Box -->
                        <div class="relative cursor-pointer" id="lowAlertBox">
                            <div class="p-2 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition duration-150">
                                <span class="text-sm font-medium">Low Stock:</span>
                                <span id="lowCount" class="font-bold text-lg ml-1">0</span>
                            </div>
                            <div id="alertDropdown" class="absolute right-0 top-full mt-2 w-72 bg-white rounded-lg shadow-xl border border-gray-200 z-30 hidden p-3">
                                <div class="text-xs text-gray-500 mb-1">Items below 3 units:</div>
                            </div>
                        </div>

                    </div>

                    <!-- Statistics Bar -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                        <div class="p-3 bg-primary-green text-white rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium opacity-80">Total Items</small>
                            <strong id="countTotal" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-blue-50 text-blue-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Groceries</small>
                            <strong id="countGroceries" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-purple-50 text-purple-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Medicines</small>
                            <strong id="countMedicines" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-yellow-50 text-yellow-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Packaged Food</small>
                            <strong id="countPackaged" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-red-50 text-red-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Low Stock</small>
                            <strong id="countLow" class="block text-xl font-extrabold">0</strong>
                        </div>
                    </div>

                    <!-- Inventory Table -->
                    <div class="overflow-x-auto scroll-table">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (â‚¹)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody" class="bg-white divide-y divide-gray-100">
                                <!-- Inventory rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sidebar (Analytics & Stats) -->
            <aside class="lg:col-span-1 space-y-6">
                
                <!-- Total Value Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100 text-center">
                    <p class="text-sm font-medium text-gray-500 mb-1">Total Inventory Value</p>
                    <div class="text-4xl font-extrabold text-primary-green">â‚¹ <span id="totalValue">0.00</span></div>
                    <p class="text-xs text-gray-400 mt-1">Value of all non-expired items in stock.</p>
                </div>

                <!-- Savings Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-500">Savings Tracked</p>
                        <div class="text-xl font-bold text-primary-dark">â‚¹ <span id="savingsValue">0.00</span></div>
                    </div>
                    <p class="text-xs text-gray-400">Value of items marked as 'Used' before their expiry date.</p>
                </div>
                
                <!-- Chart Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm font-medium text-gray-500">Stock Distribution by Category (Units)</p>
                        <span class="text-xs text-primary-green font-semibold">Live Data</span>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Edit Modal (Re-using structure, applying Tailwind) -->
    <div id="modalBackdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-lg mx-4">
            <h3 id="modalTitle" class="text-xl font-bold text-primary-dark mb-4">Edit Item</h3>
            <div class="space-y-3">
                <input id="modalName" placeholder="Name" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green" />
                <div class="flex gap-3">
                    <input id="modalQty" type="number" placeholder="Qty" class="w-1/2 px-3 py-2 border rounded-lg focus:ring-primary-green" />
                    <input id="modalPrice" type="number" step="0.01" placeholder="Price (â‚¹)" class="w-1/2 px-3 py-2 border rounded-lg focus:ring-primary-green" />
                </div>
                <input id="modalExpiry" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green" />
                <select id="modalCategory" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green">
                    <option>Groceries</option>
                    <option>Medicines</option>
                    <option>Packaged Food</option>
                    <option>Dairy & Milk Products</option>
                </select>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="modalCancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                <button id="modalSave" class="px-4 py-2 text-sm font-medium text-white bg-primary-green rounded-lg shadow-md hover:bg-emerald-600 transition duration-150">Save Changes</button>
                <button id="modalDelete" class="px-4 py-2 text-sm font-medium text-white bg-danger rounded-lg shadow-md hover:bg-red-600 transition duration-150 ml-3">Delete Item</button>
            </div>
        </div>
    </div>

<script>
// === SmartStock Dashboard Script ===
// Base API configuration
const API_BASE = 'https://smartstock-qre1.onrender.com';

// Global variables
let currentUser = null;
let inventory = [];

// Utility: Show alerts or errors
function showAlert(message, type = 'info') {
  const alertBox = document.getElementById('alertBox');
  if (!alertBox) return;
  alertBox.innerHTML = `<div class="alert ${type}">${message}</div>`;
  setTimeout(() => (alertBox.innerHTML = ''), 3000);
}

// Load current user from localStorage
function loadUser() {
  const userData = localStorage.getItem('smartstock_user');
  if (userData) {
    currentUser = JSON.parse(userData);
    const usernameEl = document.getElementById('username');
    if (usernameEl) usernameEl.innerText = currentUser.name;
  } else {
    window.location.href = 'index.html';
  }
}

// Logout
function logout() {
  localStorage.removeItem('smartstock_user');
  window.location.href = 'index.html';
}

// Fetch Inventory
async function fetchInventory() {
  if (!currentUser) return showAlert('User not logged in', 'error');
  try {
    const res = await fetch(`${API_BASE}/inventory/${currentUser.id}`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
    });
    if (!res.ok) throw new Error(`Server Error: ${res.status}`);
    const data = await res.json();
    inventory = data.inventory || [];
    renderInventory();
  } catch (err) {
    console.error(err);
    showAlert('ERROR: Unable to fetch inventory.', 'error');
  }
}

// Render Inventory
function renderInventory() {
  const tbody = document.getElementById('inventoryTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (inventory.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No items found</td></tr>`;
    return;
  }

  inventory.forEach((item, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.name}</td>
      <td>${item.category}</td>
      <td>${item.quantity}</td>
      <td>${item.price}</td>
      <td>
        <button class="btn-edit" onclick="editItem(${item.id})">Edit</button>
        <button class="btn-delete" onclick="deleteItem(${item.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Add Item
async function addItem(event) {
  event.preventDefault();
  const name = document.getElementById('itemName').value.trim();
  const category = document.getElementById('itemCategory').value.trim();
  const quantity = parseInt(document.getElementById('itemQuantity').value);
  const price = parseFloat(document.getElementById('itemPrice').value);

  if (!name || !category || isNaN(quantity) || isNaN(price)) {
    return showAlert('Please fill all fields correctly.', 'error');
  }

  try {
    const res = await fetch(`${API_BASE}/add_item/${currentUser.id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, category, quantity, price }),
    });
    if (!res.ok) throw new Error(`Failed to add item (${res.status})`);
    await fetchInventory();
    showAlert('Item added successfully!', 'success');
    document.getElementById('addItemForm').reset();
  } catch (err) {
    console.error(err);
    showAlert('Unable to add item.', 'error');
  }
}

// Edit Item
async function editItem(itemId) {
  const item = inventory.find(i => i.id === itemId);
  if (!item) return showAlert('Item not found.', 'error');

  const newName = prompt('Enter new name:', item.name);
  const newQty = prompt('Enter new quantity:', item.quantity);
  const newPrice = prompt('Enter new price:', item.price);
  if (!newName || !newQty || !newPrice) return;

  try {
    const res = await fetch(`${API_BASE}/update_item/${currentUser.id}/${itemId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: newName,
        category: item.category,
        quantity: parseInt(newQty),
        price: parseFloat(newPrice),
      }),
    });
    if (!res.ok) throw new Error(`Failed to update item (${res.status})`);
    await fetchInventory();
    showAlert('Item updated successfully!', 'success');
  } catch (err) {
    console.error(err);
    showAlert('Unable to update item.', 'error');
  }
}

// Delete Item
async function deleteItem(itemId) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  try {
    const res = await fetch(`${API_BASE}/delete_item/${currentUser.id}/${itemId}`, {
      method: 'DELETE',
    });
    if (!res.ok) throw new Error(`Failed to delete item (${res.status})`);
    await fetchInventory();
    showAlert('Item deleted successfully!', 'success');
  } catch (err) {
    console.error(err);
    showAlert('Unable to delete item.', 'error');
  }
}

// === Buffering Ghost Animation Fix ===
function hideLoader() {
  const loader = document.getElementById('ghostLoader');
  const dashboard = document.getElementById('dashboardMain');
  if (loader && dashboard) {
    loader.classList.add('fade-out');
    setTimeout(() => {
      loader.style.display = 'none';
      dashboard.style.display = 'block';
    }, 800);
  }
}

// Initialize Dashboard
window.addEventListener('DOMContentLoaded', async () => {
  loadUser();
  await fetchInventory();
  const form = document.getElementById('addItemForm');
  if (form) form.addEventListener('submit', addItem);
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.addEventListener('click', logout);
  hideLoader();
});
</script>

</body>

</html>

