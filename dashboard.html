<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock - Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Use Inter font for consistency -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        // Tailwind Configuration matching the login page theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10B981', /* Emerald Green */
                        'primary-dark': '#0F172A', /* Slate 900 */
                        'card-bg': '#FFFFFF',
                        'accent-light': '#D1FAE5', /* Emerald 100 */
                        'danger': '#EF4444', /* Red 500 */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Style adjustments for better visibility and component consistency */
        input[type="text"], input[type="number"], input[type="date"], select {
            border-color: #E5E7EB; /* Gray 200 */
            transition: all 0.15s ease-in-out;
        }
        input:focus, select:focus {
            border-color: #10B981; /* primary-green */
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .scroll-table {
            max-height: 55vh; /* Limit height for responsiveness */
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingOverlay" class="fixed inset-0 bg-primary-dark bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-white text-xl flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-primary-green" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting to SmartStock...
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Top Bar -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pb-6 border-b border-gray-200 mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary-green text-white font-extrabold shadow-lg">SI</div>
                <div>
                    <h1 class="text-2xl font-bold text-primary-dark">SmartStock Inventory</h1>
                    <p class="text-sm text-gray-500">Real-time inventory powered by Firebase</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div id="greeting" class="px-3 py-1.5 text-sm font-semibold text-primary-dark bg-accent-light rounded-lg shadow-sm">Hello, User 👋</div>
                <button id="logoutBtn" class="px-4 py-2 text-sm font-medium text-white bg-danger rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Grid Layout (Responsive) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Content Area (Inventory List & Form) -->
            <div class="lg:col-span-2">
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    
                    <!-- NEW: Inventory Title & Filter Control -->
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-primary-dark">Inventory Management</h2>
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-600">Filter by Category:</label>
                            <select id="categoryFilter" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 focus:ring-primary-green">
                                <option value="All">All Categories</option>
                                <option>Groceries</option>
                                <option>Medicines</option>
                                <option>Packaged Food</option>
                                <option>Dairy & Milk Products</option>
                            </select>
                        </div>
                    </div>
                    <!-- END NEW HEADER -->

                    <!-- Item Addition Form -->
                    <div id="addForm" class="flex flex-wrap gap-3 mb-6 p-4 bg-gray-50 rounded-lg border">
                        <input id="nameInput" type="text" placeholder="Item name" required class="flex-grow min-w-[120px] px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <input id="qtyInput" type="number" placeholder="Qty" min="0" required class="w-20 px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <input id="priceInput" type="number" step="0.01" placeholder="Price (₹)" min="0" class="w-28 px-3 py-2 rounded-lg border focus:ring-primary-green" />
                        <!-- START: Requested Label and Input -->
                        <div class="flex items-center border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <label for="expiryInput" class="text-sm text-gray-500 font-medium pl-3 pr-2">Expiry Date</label>
                            <input id="expiryInput" type="date" class="w-36 px-3 py-2 border-l border-none focus:ring-primary-green focus:border-primary-green rounded-r-lg" style="border:none;" />
                        </div>
                        <!-- END: Requested Label and Input -->
                        <select id="categoryInput" class="px-3 py-2 rounded-lg border focus:ring-primary-green">
                            <option>Groceries</option>
                            <option>Medicines</option>
                            <option>Packaged Food</option>
                            <option>Dairy & Milk Products</option>
                        </select>
                        <button id="addBtn" class="flex-shrink-0 px-4 py-2 font-medium text-white bg-primary-green rounded-lg shadow-md hover:bg-emerald-600 transition duration-150">
                            ➕ Add Item
                        </button>
                    </div>

                    <!-- Filter, Sort, and Alerts (Now just Sort and Alerts) -->
                    <div class="flex flex-wrap justify-end items-center gap-6 mb-4 border-b pb-3">
                        
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-600">Sort By:</label>
                            <select id="sortSelect" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 focus:ring-primary-green">
                                <option value="new">Newest</option>
                                <option value="name">Name</option>
                                <option value="qty_desc">Quantity ↓</option>
                                <option value="qty_asc">Quantity ↑</option>
                            </select>
                        </div>

                        <!-- Low Stock Alert Box -->
                        <div class="relative cursor-pointer" id="lowAlertBox">
                            <div class="p-2 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition duration-150">
                                <span class="text-sm font-medium">Low Stock:</span>
                                <span id="lowCount" class="font-bold text-lg ml-1">0</span>
                            </div>
                            <div id="alertDropdown" class="absolute right-0 top-full mt-2 w-72 bg-white rounded-lg shadow-xl border border-gray-200 z-30 hidden p-3">
                                <div class="text-xs text-gray-500 mb-1">Items below 3 units:</div>
                            </div>
                        </div>

                    </div>

                    <!-- Statistics Bar -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                        <div class="p-3 bg-primary-green text-white rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium opacity-80">Total Items</small>
                            <strong id="countTotal" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-blue-50 text-blue-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Groceries</small>
                            <strong id="countGroceries" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-purple-50 text-purple-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Medicines</small>
                            <strong id="countMedicines" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-yellow-50 text-yellow-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Packaged Food</small>
                            <strong id="countPackaged" class="block text-xl font-extrabold">0</strong>
                        </div>
                        <div class="p-3 bg-red-50 text-red-700 rounded-lg shadow-md text-center">
                            <small class="text-sm font-medium">Low Stock</small>
                            <strong id="countLow" class="block text-xl font-extrabold">0</strong>
                        </div>
                    </div>

                    <!-- Inventory Table -->
                    <div class="overflow-x-auto scroll-table">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (₹)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody" class="bg-white divide-y divide-gray-100">
                                <!-- Inventory rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sidebar (Analytics & Stats) -->
            <aside class="lg:col-span-1 space-y-6">
                
                <!-- Total Value Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100 text-center">
                    <p class="text-sm font-medium text-gray-500 mb-1">Total Inventory Value</p>
                    <div class="text-4xl font-extrabold text-primary-green">₹ <span id="totalValue">0.00</span></div>
                    <p class="text-xs text-gray-400 mt-1">Value of all non-expired items in stock.</p>
                </div>

                <!-- Savings Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-500">Savings Tracked</p>
                        <div class="text-xl font-bold text-primary-dark">₹ <span id="savingsValue">0.00</span></div>
                    </div>
                    <p class="text-xs text-gray-400">Value of items marked as 'Used' before their expiry date.</p>
                </div>
                
                <!-- Chart Panel -->
                <div class="bg-card-bg p-5 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm font-medium text-gray-500">Stock Distribution by Category (Units)</p>
                        <span class="text-xs text-primary-green font-semibold">Live Data</span>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Edit Modal (Re-using structure, applying Tailwind) -->
    <div id="modalBackdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-lg mx-4">
            <h3 id="modalTitle" class="text-xl font-bold text-primary-dark mb-4">Edit Item</h3>
            <div class="space-y-3">
                <input id="modalName" placeholder="Name" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green" />
                <div class="flex gap-3">
                    <input id="modalQty" type="number" placeholder="Qty" class="w-1/2 px-3 py-2 border rounded-lg focus:ring-primary-green" />
                    <input id="modalPrice" type="number" step="0.01" placeholder="Price (₹)" class="w-1/2 px-3 py-2 border rounded-lg focus:ring-primary-green" />
                </div>
                <input id="modalExpiry" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green" />
                <select id="modalCategory" class="w-full px-3 py-2 border rounded-lg focus:ring-primary-green">
                    <option>Groceries</option>
                    <option>Medicines</option>
                    <option>Packaged Food</option>
                    <option>Dairy & Milk Products</option>
                </select>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="modalCancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                <button id="modalSave" class="px-4 py-2 text-sm font-medium text-white bg-primary-green rounded-lg shadow-md hover:bg-emerald-600 transition duration-150">Save Changes</button>
                <button id="modalDelete" class="px-4 py-2 text-sm font-medium text-white bg-danger rounded-lg shadow-md hover:bg-red-600 transition duration-150 ml-3">Delete Item</button>
            </div>
        </div>
    </div>

    <script>
      (function(){
        // ========== CONFIG ==========
        // Auto-detect API base: local dev vs deployed domain. Change deployed domain below.
        const API_BASE = (window.location.hostname.includes('127.0.0.1') || window.location.hostname.includes('localhost'))
          ? 'http://127.0.0.1:8000'
          : 'https://your-render-domain.onrender.com'; // <-- replace with your Render domain
      
        const CATEGORY_LABELS = ['Groceries','Medicines','Packaged Food','Dairy & Milk Products'];
        const LOW_STOCK_THRESHOLD = 3;
      
        // ========== DOM refs (keeps your existing IDs) ==========
        const loadingOverlay = document.getElementById('loadingOverlay');
        const nameInput = document.getElementById('nameInput');
        const qtyInput = document.getElementById('qtyInput');
        const priceInput = document.getElementById('priceInput');
        const expiryInput = document.getElementById('expiryInput');
        const categoryInput = document.getElementById('categoryInput');
        const addBtn = document.getElementById('addBtn');
        const inventoryBody = document.getElementById('inventoryBody');
      
        const countTotal = document.getElementById('countTotal');
        const countGroceries = document.getElementById('countGroceries');
        const countMedicines = document.getElementById('countMedicines');
        const countPackaged = document.getElementById('countPackaged');
        const countDairy = document.getElementById('countDairy');
        const countLow = document.getElementById('countLow');
        const lowCount = document.getElementById('lowCount');
        const alertDropdown = document.getElementById('alertDropdown');
        const lowAlertBox = document.getElementById('lowAlertBox');
        const categoryFilter = document.getElementById('categoryFilter');
        const sortSelect = document.getElementById('sortSelect');
        const totalValueEl = document.getElementById('totalValue');
        const savingsValueEl = document.getElementById('savingsValue');
        const logoutBtn = document.getElementById('logoutBtn');
        const greetingEl = document.getElementById('greeting');
      
        // modal refs
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalName = document.getElementById('modalName');
        const modalQty = document.getElementById('modalQty');
        const modalPrice = document.getElementById('modalPrice');
        const modalExpiry = document.getElementById('modalExpiry');
        const modalCategory = document.getElementById('modalCategory');
        const modalCancel = document.getElementById('modalCancel');
        const modalSave = document.getElementById('modalSave');
        const modalDelete = document.getElementById('modalDelete');
      
        // Chart
        const ctxEl = document.getElementById('categoryChart');
        const chart = ctxEl ? new Chart(ctxEl.getContext('2d'), {
          type: 'doughnut',
          data: { labels: CATEGORY_LABELS, datasets: [{ data: [0,0,0,0], backgroundColor: ['#2563EB','#9333EA','#FBBF24','#D946EF'] }]},
          options: { plugins:{ legend:{ position:'bottom' } }, responsive:true, maintainAspectRatio:true }
        }) : null;
      
        // state
        let inventory = [];
        let userId = null;
        let username = null;
        let editingId = null;
      
        // ---------- util ----------
        function showLoading(){ if(loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading(){ if(loadingOverlay) loadingOverlay.classList.add('hidden'); }
        function isExpired(expiryStr){
          if(!expiryStr) return false;
          const t = new Date(); t.setHours(0,0,0,0);
          const e = new Date(expiryStr); e.setHours(0,0,0,0);
          return e < t;
        }
        function formatExpiry(dateStr){
          if(!dateStr) return '-';
          try { const d = new Date(dateStr); return d.toLocaleDateString('en-US',{month:'short', day:'numeric', year:'numeric'}); }
          catch { return dateStr; }
        }
        function escapeHtml(text){ if(text===0) return '0'; if(!text) return ''; return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
      
        // ---------- Auth helpers (access + refresh) ----------
        function getAccessToken(){ return localStorage.getItem('access_token'); }
        function getRefreshToken(){ return localStorage.getItem('refresh_token'); }
        function setTokens(access, refresh){ if(access) localStorage.setItem('access_token', access); if(refresh) localStorage.setItem('refresh_token', refresh); }
        function clearAuth(){ localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); localStorage.removeItem('user_id'); localStorage.removeItem('username'); localStorage.removeItem('isLoggedIn'); }
      
        // Refresh access token using refresh token. Returns new access token or null.
        async function refreshAccessToken(){
          const refresh = getRefreshToken();
          if(!refresh) return null;
          try {
            const res = await fetch(`${API_BASE}/refresh`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ refresh_token: refresh })
            });
            if(!res.ok) return null;
            const data = await res.json();
            if(data && data.access_token){
              setTokens(data.access_token, null);
              return data.access_token;
            }
            return null;
          } catch(err){
            console.error('Refresh failed', err);
            return null;
          }
        }
      
        // fetch wrapper that adds Authorization header and auto-refreshes once on 401
        async function fetchWithAuth(path, opts = {}){
          opts.headers = opts.headers ? {...opts.headers} : {};
          let token = getAccessToken();
          if(token) opts.headers['Authorization'] = 'Bearer ' + token;
          if(!opts.headers['Content-Type'] && !(opts.body instanceof FormData)) opts.headers['Content-Type'] = 'application/json';
      
          let res;
          try {
            res = await fetch(`${API_BASE}${path}`, opts);
          } catch(err){
            console.error('Network error', err);
            throw err;
          }
      
          if((res.status === 401 || res.status === 403)) {
            // Try refresh once
            const newToken = await refreshAccessToken();
            if(newToken){
              opts.headers['Authorization'] = 'Bearer ' + newToken;
              try {
                res = await fetch(`${API_BASE}${path}`, opts);
              } catch(err){
                console.error('Retry network error', err);
                throw err;
              }
            } else {
              // cannot refresh -> force logout
              clearAuth();
              alert('Session expired. Please log in again.');
              window.location.href = 'index.html';
              return null;
            }
          }
          return res;
        }
      
        // ---------- auth/session ----------
        function ensureAuth(){
          // login page must set these on success:
          // localStorage.setItem('access_token', ...);
          // localStorage.setItem('refresh_token', ...);
          // localStorage.setItem('user_id', String(...));
          // localStorage.setItem('username', String(...));
          const at = getAccessToken();
          const uid = localStorage.getItem('user_id');
          const uname = localStorage.getItem('username') || 'User';
          if(!uid || !uname){
            clearAuth();
            window.location.href = 'index.html';
            return false;
          }
          userId = uid;
          username = uname;
          if(greetingEl) greetingEl.textContent = `Hello, ${username} 👋`;
          // attempt to ensure access token exists; if missing, attempt refresh (synchronous-ish)
          if(!at){
            // try to refresh synchronously (await in init)
            return true; // caller will call refresh in init
          }
          return true;
        }
      
        // ---------- backend API calls ----------
        async function fetchInventoryFromServer(){
          if(!userId) return;
          showLoading();
          try {
            const res = await fetchWithAuth(`/inventory/${encodeURIComponent(userId)}`, { method:'GET' });
            if(!res){
              inventory = [];
              render();
              return;
            }
            if(!res.ok){
              console.error('Fetch inventory error', res.status);
              const text = await res.text().catch(()=>null);
              console.error(text);
              inventory = [];
              render();
              return;
            }
            const payload = await res.json().catch(()=>({ items:[] }));
            const items = payload.items || [];
            // Map to normalized shape if backend uses different names
            inventory = items.map(i => ({
              id: i.id ?? i.item_id ?? i._id ?? i.id_str ?? null,
              name: i.pname ?? i.name ?? i.product_name ?? '',
              qty: Number(i.qty ?? i.quantity ?? 0),
              price: Number(i.price ?? i.unit_price ?? 0),
              expiry: i.expiry ?? i.expiry_date ?? null,
              category: i.category ?? i.cat ?? 'Uncategorized',
              usedValue: Number(i.used_value ?? i.usedValue ?? 0),
              createdAt: i.created_at ?? i.createdAt ?? Date.now()
            }));
            render();
          } catch(err){
            console.error('Fetch inventory error', err);
            inventory = [];
            render();
          } finally { hideLoading(); }
        }
      
        async function addItemToServer(e){
          e && e.preventDefault();
          if(!userId) return console.warn('No user id');
          const name = nameInput.value.trim();
          if(!name) return alert('Item name required');
          const body = {
            pname: name,
            qty: Number(qtyInput.value) || 0,
            price: Number(priceInput.value) || 0,
            expiry: expiryInput.value || null,
            category: categoryInput.value || 'Groceries',
            used_value: 0
          };
          showLoading();
          try {
            const res = await fetchWithAuth(`/add_item/${encodeURIComponent(userId)}`, {
              method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
            });
            if(!res){
              // logout handled in fetchWithAuth
              return;
            }
            if(!res.ok){
              const data = await res.json().catch(()=>null);
              alert(data?.detail || data?.message || `Add failed (status ${res.status})`);
            } else {
              clearAddForm();
              await fetchInventoryFromServer();
            }
          } catch(err){
            console.error('Add item error', err);
            alert('Cannot reach server to add item.');
          } finally { hideLoading(); }
        }
      
        async function updateItemOnServer(itemId, updates){
          if(!userId) return;
          showLoading();
          try {
            const res = await fetchWithAuth(`/update_item/${encodeURIComponent(userId)}/${encodeURIComponent(itemId)}`, {
              method: 'PUT', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(updates)
            });
            if(!res) return false;
            if(res.ok) { await fetchInventoryFromServer(); return true; }
            const txt = await res.text().catch(()=>null);
            console.error('Update failed', res.status, txt);
            alert(`Update failed: ${res.status}`);
            return false;
          } catch(err){
            console.error('Update error', err);
            alert('Cannot reach server to update item.');
            return false;
          } finally { hideLoading(); }
        }
      
        async function deleteItemOnServer(itemId){
          if(!userId) return;
          if(!confirm('Are you sure you want to delete this item?')) return;
          showLoading();
          try {
            const res = await fetchWithAuth(`/delete_item/${encodeURIComponent(userId)}/${encodeURIComponent(itemId)}`, { method:'DELETE' });
            if(!res) return;
            if(res.ok) { await fetchInventoryFromServer(); }
            else {
              const txt = await res.text().catch(()=>null);
              console.error('Delete failed', res.status, txt);
              alert('Delete failed: ' + res.status);
            }
          } catch(err){
            console.error('Delete error', err);
            alert('Cannot reach server to delete item.');
          } finally { hideLoading(); }
        }
      
        async function useItemOnServer(itemId, n=1){
          if(!userId) return;
          const item = inventory.find(x => x.id === itemId);
          if(!item) return;
          const newQty = Math.max(0, (Number(item.qty)||0) - n);
          const updates = { qty: newQty };
          if(item.expiry && !isExpired(item.expiry)) {
            updates.used_value = (Number(item.usedValue||0) + (n * (Number(item.price)||0)));
          }
          await updateItemOnServer(itemId, updates);
        }
        async function fetchAlerts() {
  const token = localStorage.getItem("token");
  const res = await fetch(`${API_BASE_URL}/alerts`, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  const alerts = await res.json();

  if (alerts.length > 0) {
    const msg = alerts.map(a => 
      `⚠️ ${a.pname} expires in ${a.days_left} days`
    ).join("\n");
    alert(msg); // or display in a styled notification box
  }
}
window.onload = fetchAlerts;

      
        // ---------- render ----------
        function render(){
          let list = [...inventory];
          const filter = (categoryFilter && categoryFilter.value) || 'All';
          if(filter && filter !== 'All') list = list.filter(i => i.category === filter);
          const sort = (sortSelect && sortSelect.value) || 'new';
          if(sort === 'name') list.sort((a,b)=> a.name.localeCompare(b.name));
          else if(sort === 'qty_desc') list.sort((a,b)=> b.qty - a.qty);
          else if(sort === 'qty_asc') list.sort((a,b)=> a.qty - b.qty);
          else list.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      
          inventoryBody.innerHTML = '';
          if(list.length === 0) {
            inventoryBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No items found in this view.</td></tr>';
          } else {
            list.forEach(item=>{
              const isLow = (Number(item.qty)||0) <= LOW_STOCK_THRESHOLD;
              const expired = isExpired(item.expiry);
              const tr = document.createElement('tr');
              tr.className = `${isLow ? 'bg-red-50 hover:bg-red-100' : 'bg-white hover:bg-gray-50'} ${expired ? 'opacity-50' : ''}`;
              tr.innerHTML = `
                <td class="px-4 py-3 text-sm font-medium text-gray-900 truncate">${escapeHtml(item.name)} ${expired ? '<span class="text-xs text-red-500 font-semibold">(Expired)</span>' : ''}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${escapeHtml(item.category)}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <div class="flex items-center space-x-2">
                    <span>${item.qty}</span>
                    <button data-id="${item.id}" data-action="use-1" class="text-xs px-2 py-0.5 border border-primary-green text-primary-green rounded-md hover:bg-primary-green hover:text-white transition duration-150">Use -1</button>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">₹ ${Number(item.price||0).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${expired ? 'text-red-600 font-semibold' : 'text-gray-900'}">${formatExpiry(item.expiry)}</td>
                <td class="px-4 py-3 text-sm font-medium">
                  <button data-id="${item.id}" data-action="edit" class="text-primary-green hover:text-emerald-600 transition duration-150 mr-2">Edit</button>
                  <button data-id="${item.id}" data-action="delete" class="text-danger hover:text-red-600 transition duration-150">Delete</button>
                </td>
              `;
              tr.querySelectorAll('button').forEach(btn=>{
                const id = btn.dataset.id;
                const action = btn.dataset.action;
                if(action === 'edit') btn.addEventListener('click', ()=> openEditModal(id));
                if(action === 'delete') btn.addEventListener('click', ()=> deleteItemOnServer(id));
                if(action === 'use-1') btn.addEventListener('click', ()=> useItemOnServer(id,1));
              });
              inventoryBody.appendChild(tr);
            });
          }
          updateStatsAndUI();
        }
      
        function updateStatsAndUI(){
          const counts = {'Groceries':0,'Medicines':0,'Packaged Food':0,'Dairy & Milk Products':0};
          let low = [], totalVal=0, savings=0, totalItems=0;
          for(const it of inventory){
            totalItems++;
            if(counts[it.category] !== undefined) counts[it.category] += 1;
            if((Number(it.qty)||0) <= LOW_STOCK_THRESHOLD) low.push(it);
            if(!isExpired(it.expiry)) totalVal += (Number(it.price)||0) * (Number(it.qty)||0);
            savings += Number(it.usedValue||0);
          }
          if(countTotal) countTotal.textContent = totalItems;
          if(countGroceries) countGroceries.textContent = counts['Groceries'];
          if(countMedicines) countMedicines.textContent = counts['Medicines'];
          if(countPackaged) countPackaged.textContent = counts['Packaged Food'];
          if(countDairy) countDairy.textContent = counts['Dairy & Milk Products'];
          if(countLow) countLow.textContent = low.length;
          if(lowCount) lowCount.textContent = low.length;
          if(totalValueEl) totalValueEl.textContent = totalVal.toFixed(2);
          if(savingsValueEl) savingsValueEl.textContent = savings.toFixed(2);
      
          if(alertDropdown){
            alertDropdown.innerHTML = '';
            if(low.length === 0) alertDropdown.innerHTML = '<div class="p-2 text-sm text-gray-500">No low stock items — all good 👍</div>';
            else {
              low.forEach(i=>{
                const d = document.createElement('div');
                d.className = 'p-2 rounded-lg bg-red-50 text-sm text-red-700 hover:bg-red-100 cursor-pointer mb-1 flex justify-between items-center';
                d.innerHTML = `<span class="font-medium">${escapeHtml(i.name)}</span><span class="font-bold">${i.qty} units</span>`;
                d.addEventListener('click', ()=> openEditModal(i.id));
                alertDropdown.appendChild(d);
              });
            }
          }
      
          if(chart){
            const data = CATEGORY_LABELS.map(lbl => inventory.filter(it=>it.category===lbl).reduce((s,c)=>s+(Number(c.qty)||0),0));
            chart.data.datasets[0].data = data;
            chart.update();
          }
        }
      
        // ---------- modal and form ----------
        function clearAddForm(){ if(nameInput) nameInput.value=''; if(qtyInput) qtyInput.value=''; if(priceInput) priceInput.value=''; if(expiryInput) expiryInput.value=''; if(categoryInput) categoryInput.selectedIndex = 0; }
      
        function openEditModal(id){
          const item = inventory.find(x=>x.id===id);
          if(!item) return;
          editingId = id;
          if(modalTitle) modalTitle.textContent = 'Edit Item: ' + item.name;
          if(modalName) modalName.value = item.name;
          if(modalQty) modalQty.value = item.qty;
          if(modalPrice) modalPrice.value = item.price;
          if(modalExpiry) modalExpiry.value = item.expiry || '';
          if(modalCategory) modalCategory.value = item.category || CATEGORY_LABELS[0];
          if(modalBackdrop) modalBackdrop.classList.remove('hidden');
        }
        function closeModal(){ editingId = null; if(modalBackdrop) modalBackdrop.classList.add('hidden'); }
      
        async function handleSaveModal(e){
          e && e.preventDefault();
          if(!editingId) return;
          const updates = {
            pname: modalName.value.trim(),
            qty: Number(modalQty.value) || 0,
            price: Number(modalPrice.value) || 0,
            expiry: modalExpiry.value || null,
            category: modalCategory.value
          };
          await updateItemOnServer(editingId, updates);
          closeModal();
        }
        async function handleDeleteFromModal(e){
          e && e.preventDefault();
          if(!editingId) return;
          await deleteItemOnServer(editingId);
          closeModal();
        }
      
        // ---------- logout ----------
        function performLogout(){
          clearAuth();
          window.location.href = 'index.html';
        }
      
        // ---------- init/wiring ----------
        async function init(){
          // ensure basic auth keys are present; if access token missing, try refresh before making calls
          if(!ensureAuth()) return;
          // if access token missing but refresh exists, attempt refresh
          if(!getAccessToken() && getRefreshToken()){
            showLoading();
            try {
              const got = await refreshAccessToken();
              if(!got){
                clearAuth();
                window.location.href = 'index.html';
                return;
              }
            } finally {
              hideLoading();
            }
          }
          showLoading();
          try { await fetchInventoryFromServer(); }
          finally { hideLoading(); }
        }
      
        document.addEventListener('DOMContentLoaded', ()=>{
          if(!ensureAuth()) return;
          init();
          if(addBtn) addBtn.addEventListener('click', addItemToServer);
          if(logoutBtn) logoutBtn.addEventListener('click', performLogout);
          if(categoryFilter) categoryFilter.addEventListener('change', render);
          if(sortSelect) sortSelect.addEventListener('change', render);
      
          if(modalCancel) modalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
          if(modalSave) modalSave.addEventListener('click', handleSaveModal);
          if(modalDelete) modalDelete.addEventListener('click', handleDeleteFromModal);
      
          if(lowAlertBox) lowAlertBox.addEventListener('click', (e)=>{ e.stopPropagation(); if(alertDropdown) alertDropdown.classList.toggle('hidden'); });
          document.addEventListener('click', (e)=>{ if(alertDropdown && !alertDropdown.classList.contains('hidden') && lowAlertBox && !lowAlertBox.contains(e.target)) alertDropdown.classList.add('hidden'); });
      
          // bind modal interactions (safety)
          if(modalBackdrop) modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
        });
      
      })();
      </script>
      

</body>
</html>